Original code by [REDACTED]
Updated to Lua by Flame